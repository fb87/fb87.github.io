<!doctype html><html lang="en" ng-app="Blog"><head><meta charset="UTF-8"><meta name="description" content="My Personal Blog"><meta name="keywords" content="blog, shell, linux, dev, coding"><meta name="author" content="Si Dao"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Host an Onion hidden service using Raspberry Pi...</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-coy-without-shadows.css"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=BIZ+UDMincho&family=Special+Elite&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css"><link rel="stylesheet" href="/style/css/index.css"><script language="Javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.js"></script><link rel="stylesheet" href="https://unpkg.com/speedlify-score@1.0.2/speedlify-score.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/speedlify-score@1.0.2/speedlify-score.js" async defer="defer"></script></head><body><div ng-controller="ngPostFilterController"><h2>/DOC/(S)</h2><blockquote><p><small>[~] learn and share...</small></p></blockquote><div class="row" style="width: 100%; align-items:center; display: flex;"><div class="column column-80"><a style="padding-right: 5px; padding-right: 5px;" href="/">HOME</a> / <a style="padding-right: 5px; padding-right: 5px;" href="/posts">ARCHIVE</a> / <a style="padding-right: 5px; padding-right: 5px;" href="/about">ABOUT</a></div><div class="column"><div class="row"><input type="text" size="20" style="float: right; margin-left: auto;" ng-model="search_tokens" placeholder="Search..."> <button ng-click="toogle_language()" ng-bind="is_en ? 'EN' : 'VI'"></button></div></div></div><hr><div style="min-height: 90%; width: 100%" ng-show="search_tokens.length > 0"><h2>[>] First 20 (max) topics found</h2><ol><li ng-show="lang == post.lang" width="100%" ng-repeat="post in all_titles | filter:search_tokens | limitTo:20"><span style="float: right;" ng-bind="post.date"></span> [~] <a style="text-decoration: none;" ng-href=" {{ post.url}} " ng-bind="post.title"></a></li></ol></div></div><header><h2>[:] Host an Onion hidden service using Raspberry Pi...</h2></header><main><h3>Pre-require</h3><ul><li>A Raspberry Pi Board + SDCard (&gt;= 1GB)</li><li>Basic Linux knowledge</li></ul><h3>Install Linux OS on RPi</h3><p>Follow <a href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi_-_Headless_Installation">RPi Alpine Headless</a> to prepare base software on RPi board, <strong>diskless</strong> mode is recommended. It's recommended to have 1 R/W partition to store Tor config and Web contents. Partition scheme should look like:</p><ul><li>Boot partition (Fat format) ~256MiB</li><li>Persistent partition (Ext4 format) size dependent.</li></ul><p>From my experience, our system comsumes about 80MiB RAM runtime, there is no need to have swap partition.</p><h3>Install Tor and Nginx</h3><ul><li>Mount second partition to e.g <code>/media/data</code></li><li>Install <code>tor</code>, <code>nginx</code><pre><code class="language-bash">~# apk add nginx tor
</code></pre></li><li>Create <code>torrc</code> by copying <code>/etc/tor/torrc.sample</code><pre><code class="language-bash">~# cp /etc/tor/torrc.sample /etc/tor/torrc
</code></pre></li><li>Mount data partition<pre><code class="language-bash">~# mkdir /media/data
~# mount /dev/mmcblk0p2 /media/data
</code></pre></li><li>Create mount point for our hidden service<pre><code class="language-bash">~# mkdir /media/data/var/lib/tor/hidden_service
~# chown tor -R /media/data/var
~# chmod -R 0700 /media/data/var
~# mkdir /media/data/htdocs
</code></pre></li><li>Enable hidden service on <code>torrc</code><ul><li>Before<pre><code class="language-shell"># HiddenServiceDir /media/data/var/lib/tor/hidden_service
# HiddenServicePort 80 127.0.0.1:80
</code></pre></li><li>After<pre><code class="language-bash">HiddenServiceDir /media/data/var/lib/tor/hidden_service/

# bind to socket instead to avoid exposing ourselves to out side
HiddenServicePort 80 unix:/var/run/onion.sock
</code></pre></li></ul></li><li>Restart <strong>tor</strong> service to get hostname<pre><code class="language-bash">~# rc-update add tor
~# rc-update add nginx
~# service tor restart
</code></pre></li></ul><blockquote><p>Check <code>/media/data/var/lib/tor/hidden_service/hostname</code> to find host name of our hidden service, this info need to be filled into nginx configuration later on.</p></blockquote><ul><li>Create virtual server on <strong>nginx</strong> to bind to <strong>tor</strong> socket by edit <code>/etc/nginx/http.d/default</code>, replace it with content below:<pre><code class="language-bash">server {
  listen unix:/var/run/onion.sock;
  server_name &lt;your-onion-address&gt;.onion;
  access_log /var/log/nginx/onion.log;
  index index.html;
  root /media/data/htdocs;
}
</code></pre></li></ul><blockquote><p>Fill <strong>your-onion-address</strong> with content from <code>/media/data/var/lib/tor/hidden_service/hostname</code></p></blockquote><ul><li>Create <strong>/media/data/htdocs/index.html</strong> with simple html content to test e.g <code>&lt;h1&gt;Welcome to my site&lt;/h1&gt;</code></li><li>Restart <strong>nginx</strong> <code>service nginx restart</code></li></ul><p>Check if our web is up and running using <a href="https://www.torproject.org/download/"><strong>Tor Browser</strong></a> with address indecated by content of <code>/media/data/var/lib/tor/hidden_service/hostname</code>.</p><ul><li>Save all the changes<pre><code class="language-bash">~# lbu commit
</code></pre></li></ul><blockquote><p>Important! per each step above, it'd better to run <code>lbu commit</code> to save all modifications</p></blockquote><h3>Reference</h3><ul><li><a href="https://community.torproject.org/onion-services/setup/">Onion Hidden Service</a></li><li><a href="https://wiki.alpinelinux.org/wiki/Raspberry_Pi_-_Headless_Installation">Alpine headless on Raspberry Pi</a></li></ul></main><hr><div ng-controller="ngCommentController"><a href="#" ng-click="find_comment(6)">[ Show ]</a> comments<ul><li ng-repeat="comment in comments">[<a href="{{ comment.user.html_url }}">{{ comment.user.login }}</a> - {{ comment.updated_at }}] <a href="{{ comment.html_url }}">{{ comment.body }}</a></li></ul><p ng-bind="warn_message"></p><span ng-if="channel"><a href="{{ channel }}">[ Join ]</a> discussion</span></div><hr><div width="100%" style="text-align: right;"><speedlify-score speedlify-url="https://www.11ty.dev/speedlify" hash="1bb9ec60" score weight rank rank-change></speedlify-score><small style="color: grey; font-style: italic;">(C)2022 - dao [dot] singoc [dot] com</small></div><script language="Javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script><script language="Javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js"></script><script language="Javascript" src="/style/js/index.min.js"></script></body></html>